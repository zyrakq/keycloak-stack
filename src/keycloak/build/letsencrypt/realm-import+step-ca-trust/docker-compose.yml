services:
  keycloak-db:
    container_name: keycloak-db
    image: postgres:${POSTGRES_VERSION:-16.2}
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    logging:
      driver: "json-file"
      options:
        max-size: 10m
        max-file: 3
    healthcheck:
      test: ["CMD-SHELL", "/bin/sh", "-c", "exec pg_isready -h 127.0.0.1"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    networks:
      - keycloak-network
  keycloak:
    container_name: keycloak
    image: keycloak
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/${POSTGRES_DB}
      KC_DB_USERNAME: ${POSTGRES_USER}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_FEATURES: token-exchange
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
      KC_HTTP_ENABLED: "true"
      PROXY_ADDRESS_FORWARDING: "true"
      KC_CACHE_STACK: tcp
      VIRTUAL_PORT: ${VIRTUAL_PORT}
      VIRTUAL_HOST: ${VIRTUAL_HOST}
      LETSENCRYPT_HOST: ${LETSENCRYPT_HOST}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
      STEP_CA_TRUST: ${STEP_CA_TRUST:-true}
      STEP_CA_TRUST_RESTART: ${STEP_CA_TRUST_RESTART:-true}
    command: "start --http-port=8080 --proxy=edge --import-realm"
    logging:
      driver: "json-file"
      options:
        max-size: 10m
        max-file: 3
    depends_on:
      - keycloak-db
    networks:
      - keycloak-network
      - letsencrypt-network
    build:
      context: .
      args:
        KEYCLOAK_VERSION: ${KEYCLOAK_VERSION:-23.0}
networks:
  keycloak-network:
    name: keycloak-network
    driver: bridge
  letsencrypt-network:
    external: true
volumes:
  keycloak-db:
    name: keycloak-db
    driver: local
